# High level overview on our URL mangement

## Version

- We migrate URL search params.
- Migrated URLs have a `v` search param.
- Each migration has software tests.
- The version applies to all search params.
- If the version param is missing, the migration runs. If params cannot be migrated, they fall back to defaults.

Migrations for regions (which are `params.regionSlug`) happen inside the middleware.ts.

## `config` search params

### Version 2

Version 2 encodes the current map state config in a short string like `config=1oy2q4i.jz9kth.bqcg3k.f4`.

The short URL is created by splitting the config template and the config state.

- The config template is stored on disc and referenced in part 1.
- The config state (the true, false of all the `active` properties) is encoded in part 2.

**Part 1 of the `config` search params is a hased reference (checksum) to a config template:**

[Example `1oy2q4i`](./v2/configs/_1oy2q4i.ts).

The template represents a [`simplifyConfigForParams`](./v1/configCustomStringify.ts) object that represents the fixed combination of categories and subcategories from [`categories.const.ts`](/src/app/regionen/[regionSlug]/_mapData/mapDataCategories/categories.const.ts).

The reference hash/checksum is generated by [`calcConfigChecksum`](./v2/lib.ts).

Whenever we change the `categories.const.ts`, the test [`checksums.test.ts`](./v2/tests/checksums.test.ts) will fail and remind us to run `npm run save-configs` to generate and store a new config template.

Side note: The `active` properties in the config templates represent the default values at the given time but are not used anywhere. Instead they are overwritten by the values from part 2 and then merged with [`mergeCategoriesConfig`](./v1/mergeCategoriesConfig.ts)

**Part 2 of the `config` search params are encoded `active:true|false` values:**

Example: `jz9kth.bqcg3k.f4`

In [`serialize`](./v2/serialize.ts) the `active:true|false` values are stored in just the right order that fits to the given config template from part 1. They are then encoded into a short string.
